{"ast":null,"code":"import _regeneratorRuntime from\"C:/Users/yeldos.k/Desktop/final-map-app/client/client/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _objectSpread from\"C:/Users/yeldos.k/Desktop/final-map-app/client/client/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _asyncToGenerator from\"C:/Users/yeldos.k/Desktop/final-map-app/client/client/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import{createApi,fetchBaseQuery}from'@reduxjs/toolkit/query/react';import{setCredentials}from'../../features/auth/authSlice';var baseQuery=fetchBaseQuery({baseUrl:'http://localhost:3500',credentials:'include',prepareHeaders:function prepareHeaders(headers,_ref){var getState=_ref.getState;var token=getState().auth.token;if(token){headers.set(\"authorization\",\"Bearer \".concat(token));}return headers;}});var baseQueryWithReauth=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(args,api,extraOptions){var _result,_result$error;var result,refreshResult,_refreshResult$error;return _regeneratorRuntime().wrap(function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:_context.next=2;return baseQuery(args,api,extraOptions);case 2:result=_context.sent;if(!(((_result=result)===null||_result===void 0?void 0:(_result$error=_result.error)===null||_result$error===void 0?void 0:_result$error.status)===403)){_context.next=17;break;}console.log('sending refresh token');// send refresh token to get new access token \n_context.next=7;return baseQuery('/auth/refresh',api,extraOptions);case 7:refreshResult=_context.sent;if(!(refreshResult!==null&&refreshResult!==void 0&&refreshResult.data)){_context.next=15;break;}// store the new token \napi.dispatch(setCredentials(_objectSpread({},refreshResult.data)));// retry original query with new access token\n_context.next=12;return baseQuery(args,api,extraOptions);case 12:result=_context.sent;_context.next=17;break;case 15:if((refreshResult===null||refreshResult===void 0?void 0:(_refreshResult$error=refreshResult.error)===null||_refreshResult$error===void 0?void 0:_refreshResult$error.status)===403){refreshResult.error.data.message=\"Your login has expired. \";}return _context.abrupt(\"return\",refreshResult);case 17:return _context.abrupt(\"return\",result);case 18:case\"end\":return _context.stop();}},_callee);}));return function baseQueryWithReauth(_x,_x2,_x3){return _ref2.apply(this,arguments);};}();export var apiSlice=createApi({baseQuery:baseQuery,tagTypes:['User'],endpoints:function endpoints(builder){return{};}});","map":{"version":3,"names":["createApi","fetchBaseQuery","setCredentials","baseQuery","baseUrl","credentials","prepareHeaders","headers","_ref","getState","token","auth","set","concat","baseQueryWithReauth","_ref2","_asyncToGenerator","_regeneratorRuntime","mark","_callee","args","api","extraOptions","_result","_result$error","result","refreshResult","_refreshResult$error","wrap","_callee$","_context","prev","next","sent","error","status","console","log","data","dispatch","_objectSpread","message","abrupt","stop","_x","_x2","_x3","apply","arguments","apiSlice","tagTypes","endpoints","builder"],"sources":["C:/Users/yeldos.k/Desktop/final-map-app/client/client/src/app/api/apiSlice.js"],"sourcesContent":["import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react'\r\nimport { setCredentials } from '../../features/auth/authSlice'\r\n\r\nconst baseQuery = fetchBaseQuery({\r\n    baseUrl: 'http://localhost:3500',\r\n    credentials: 'include',\r\n    prepareHeaders: (headers, { getState }) => {\r\n        const token = getState().auth.token\r\n\r\n        if (token) {\r\n            headers.set(\"authorization\", `Bearer ${token}`)\r\n        }\r\n        return headers\r\n    }\r\n})\r\n\r\n\r\nconst baseQueryWithReauth = async (args, api, extraOptions) => {\r\n    // console.log(args) // request url, method, body\r\n    // console.log(api) // signal, dispatch, getState()\r\n    // console.log(extraOptions) //custom like {shout: true}\r\n\r\n    let result = await baseQuery(args, api, extraOptions)\r\n\r\n    // If you want, handle other status codes, too\r\n    if (result?.error?.status === 403) {\r\n        console.log('sending refresh token')\r\n\r\n        // send refresh token to get new access token \r\n        const refreshResult = await baseQuery('/auth/refresh', api, extraOptions)\r\n\r\n        if (refreshResult?.data) {\r\n\r\n            // store the new token \r\n            api.dispatch(setCredentials({ ...refreshResult.data }))\r\n\r\n            // retry original query with new access token\r\n            result = await baseQuery(args, api, extraOptions)\r\n        } else {\r\n\r\n            if (refreshResult?.error?.status === 403) {\r\n                refreshResult.error.data.message = \"Your login has expired. \"\r\n            }\r\n            return refreshResult\r\n        }\r\n    }\r\n\r\n    return result\r\n}\r\n\r\n\r\nexport const apiSlice = createApi({ \r\n    baseQuery,\r\n    tagTypes: ['User'],\r\n    endpoints: builder =>  ({})\r\n})"],"mappings":"gbAAA,OAASA,SAAS,CAAEC,cAAc,KAAQ,8BAA8B,CACxE,OAASC,cAAc,KAAQ,+BAA+B,CAE9D,GAAM,CAAAC,SAAS,CAAGF,cAAc,CAAC,CAC7BG,OAAO,CAAE,uBAAuB,CAChCC,WAAW,CAAE,SAAS,CACtBC,cAAc,CAAE,SAAAA,eAACC,OAAO,CAAAC,IAAA,CAAmB,IAAf,CAAAC,QAAQ,CAAAD,IAAA,CAARC,QAAQ,CAChC,GAAM,CAAAC,KAAK,CAAGD,QAAQ,CAAC,CAAC,CAACE,IAAI,CAACD,KAAK,CAEnC,GAAIA,KAAK,CAAE,CACPH,OAAO,CAACK,GAAG,CAAC,eAAe,WAAAC,MAAA,CAAYH,KAAK,CAAE,CAAC,CACnD,CACA,MAAO,CAAAH,OAAO,CAClB,CACJ,CAAC,CAAC,CAGF,GAAM,CAAAO,mBAAmB,6BAAAC,KAAA,CAAAC,iBAAA,cAAAC,mBAAA,GAAAC,IAAA,CAAG,SAAAC,QAAOC,IAAI,CAAEC,GAAG,CAAEC,YAAY,MAAAC,OAAA,CAAAC,aAAA,KAAAC,MAAA,CAAAC,aAAA,CAAAC,oBAAA,QAAAV,mBAAA,GAAAW,IAAA,UAAAC,SAAAC,QAAA,iBAAAA,QAAA,CAAAC,IAAA,CAAAD,QAAA,CAAAE,IAAA,SAAAF,QAAA,CAAAE,IAAA,SAKnC,CAAA7B,SAAS,CAACiB,IAAI,CAAEC,GAAG,CAAEC,YAAY,CAAC,QAAjDG,MAAM,CAAAK,QAAA,CAAAG,IAAA,MAGN,EAAAV,OAAA,CAAAE,MAAM,UAAAF,OAAA,kBAAAC,aAAA,CAAND,OAAA,CAAQW,KAAK,UAAAV,aAAA,iBAAbA,aAAA,CAAeW,MAAM,IAAK,GAAG,GAAAL,QAAA,CAAAE,IAAA,WAC7BI,OAAO,CAACC,GAAG,CAAC,uBAAuB,CAAC,CAEpC;AAAAP,QAAA,CAAAE,IAAA,SAC4B,CAAA7B,SAAS,CAAC,eAAe,CAAEkB,GAAG,CAAEC,YAAY,CAAC,QAAnEI,aAAa,CAAAI,QAAA,CAAAG,IAAA,MAEfP,aAAa,SAAbA,aAAa,WAAbA,aAAa,CAAEY,IAAI,GAAAR,QAAA,CAAAE,IAAA,WAEnB;AACAX,GAAG,CAACkB,QAAQ,CAACrC,cAAc,CAAAsC,aAAA,IAAMd,aAAa,CAACY,IAAI,CAAE,CAAC,CAAC,CAEvD;AAAAR,QAAA,CAAAE,IAAA,UACe,CAAA7B,SAAS,CAACiB,IAAI,CAAEC,GAAG,CAAEC,YAAY,CAAC,SAAjDG,MAAM,CAAAK,QAAA,CAAAG,IAAA,CAAAH,QAAA,CAAAE,IAAA,kBAGN,GAAI,CAAAN,aAAa,SAAbA,aAAa,kBAAAC,oBAAA,CAAbD,aAAa,CAAEQ,KAAK,UAAAP,oBAAA,iBAApBA,oBAAA,CAAsBQ,MAAM,IAAK,GAAG,CAAE,CACtCT,aAAa,CAACQ,KAAK,CAACI,IAAI,CAACG,OAAO,CAAG,0BAA0B,CACjE,CAAC,OAAAX,QAAA,CAAAY,MAAA,UACMhB,aAAa,iBAAAI,QAAA,CAAAY,MAAA,UAIrBjB,MAAM,2BAAAK,QAAA,CAAAa,IAAA,MAAAxB,OAAA,GAChB,kBA/BK,CAAAL,mBAAmBA,CAAA8B,EAAA,CAAAC,GAAA,CAAAC,GAAA,SAAA/B,KAAA,CAAAgC,KAAA,MAAAC,SAAA,OA+BxB,CAGD,MAAO,IAAM,CAAAC,QAAQ,CAAGjD,SAAS,CAAC,CAC9BG,SAAS,CAATA,SAAS,CACT+C,QAAQ,CAAE,CAAC,MAAM,CAAC,CAClBC,SAAS,CAAE,SAAAA,UAAAC,OAAO,QAAM,CAAC,CAAC,EAC9B,CAAC,CAAC"},"metadata":{},"sourceType":"module","externalDependencies":[]}