{"ast":null,"code":"import _regeneratorRuntime from\"C:/Users/yeldos.k/Desktop/final-map-app/client/client/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"C:/Users/yeldos.k/Desktop/final-map-app/client/client/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"C:/Users/yeldos.k/Desktop/final-map-app/client/client/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import{Outlet,Link}from\"react-router-dom\";import{useEffect,useRef,useState}from'react';import{useRefreshMutation}from\"./authApiSlice\";import usePersist from\"../../hooks/usePersist\";import{useSelector}from'react-redux';import{selectCurrentToken}from\"./authSlice\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var PersistLogin=function PersistLogin(){var _usePersist=usePersist(),_usePersist2=_slicedToArray(_usePersist,1),persist=_usePersist2[0];var token=useSelector(selectCurrentToken);var effectRan=useRef(false);var _useState=useState(false),_useState2=_slicedToArray(_useState,2),trueSuccess=_useState2[0],setTrueSuccess=_useState2[1];var _useRefreshMutation=useRefreshMutation(),_useRefreshMutation2=_slicedToArray(_useRefreshMutation,2),refresh=_useRefreshMutation2[0],_useRefreshMutation2$=_useRefreshMutation2[1],isUninitialized=_useRefreshMutation2$.isUninitialized,isLoading=_useRefreshMutation2$.isLoading,isSuccess=_useRefreshMutation2$.isSuccess,isError=_useRefreshMutation2$.isError,error=_useRefreshMutation2$.error;useEffect(function(){if(effectRan.current===true||process.env.NODE_ENV!=='development'){// React 18 Strict Mode\nvar verifyRefreshToken=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(){return _regeneratorRuntime().wrap(function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:console.log('verifying refresh token');_context.prev=1;_context.next=4;return refresh();case 4://const { accessToken } = response.data\nsetTrueSuccess(true);_context.next=10;break;case 7:_context.prev=7;_context.t0=_context[\"catch\"](1);console.error(_context.t0);case 10:case\"end\":return _context.stop();}},_callee,null,[[1,7]]);}));return function verifyRefreshToken(){return _ref.apply(this,arguments);};}();if(!token&&persist)verifyRefreshToken();}return function(){return effectRan.current=true;};// eslint-disable-next-line\n},[]);var content;if(!persist){// persist: no\nconsole.log('no persist');content=/*#__PURE__*/_jsx(Outlet,{});}else if(isLoading){//persist: yes, token: no\nconsole.log('loading');content=/*#__PURE__*/_jsx(\"p\",{children:\"\\u0417\\u0430\\u0433\\u0440\\u0443\\u0437\\u043A\\u0430...\"});}else if(isError){var _error$data;//persist: yes, token: no\nconsole.log('error');content=/*#__PURE__*/_jsxs(\"p\",{className:\"errmsg\",children:[\"\".concat(error===null||error===void 0?void 0:(_error$data=error.data)===null||_error$data===void 0?void 0:_error$data.message,\" - \"),/*#__PURE__*/_jsx(Link,{to:\"/login\",children:\"\\u041F\\u043E\\u0436\\u0430\\u043B\\u0443\\u0439\\u0441\\u0442\\u0430, \\u0432\\u043E\\u0439\\u0434\\u0438\\u0442\\u0435 \\u0435\\u0449\\u0435 \\u0440\\u0430\\u0437\"}),\".\"]});}else if(isSuccess&&trueSuccess){//persist: yes, token: yes\nconsole.log('success');content=/*#__PURE__*/_jsx(Outlet,{});}else if(token&&isUninitialized){//persist: yes, token: yes\nconsole.log('token and uninit');console.log(isUninitialized);content=/*#__PURE__*/_jsx(Outlet,{});}return content;};export default PersistLogin;","map":{"version":3,"names":["Outlet","Link","useEffect","useRef","useState","useRefreshMutation","usePersist","useSelector","selectCurrentToken","jsx","_jsx","jsxs","_jsxs","PersistLogin","_usePersist","_usePersist2","_slicedToArray","persist","token","effectRan","_useState","_useState2","trueSuccess","setTrueSuccess","_useRefreshMutation","_useRefreshMutation2","refresh","_useRefreshMutation2$","isUninitialized","isLoading","isSuccess","isError","error","current","process","env","NODE_ENV","verifyRefreshToken","_ref","_asyncToGenerator","_regeneratorRuntime","mark","_callee","wrap","_callee$","_context","prev","next","console","log","t0","stop","apply","arguments","content","children","_error$data","className","concat","data","message","to"],"sources":["C:/Users/yeldos.k/Desktop/final-map-app/client/client/src/features/auth/PersistLogin.js"],"sourcesContent":["import { Outlet, Link } from \"react-router-dom\"\r\nimport { useEffect, useRef, useState } from 'react'\r\nimport { useRefreshMutation } from \"./authApiSlice\"\r\nimport usePersist from \"../../hooks/usePersist\"\r\nimport { useSelector } from 'react-redux'\r\nimport { selectCurrentToken } from \"./authSlice\"\r\n\r\nconst PersistLogin = () => {\r\n\r\n    const [persist] = usePersist()\r\n    const token = useSelector(selectCurrentToken)\r\n    const effectRan = useRef(false)\r\n\r\n    const [trueSuccess, setTrueSuccess] = useState(false)\r\n\r\n    const [refresh, {\r\n        isUninitialized,\r\n        isLoading,\r\n        isSuccess,\r\n        isError,\r\n        error\r\n    }] = useRefreshMutation()\r\n\r\n\r\n    useEffect(() => {\r\n\r\n        if (effectRan.current === true || process.env.NODE_ENV !== 'development') { // React 18 Strict Mode\r\n\r\n            const verifyRefreshToken = async () => {\r\n                console.log('verifying refresh token')\r\n                try {\r\n                    //const response = \r\n                    await refresh()\r\n                    //const { accessToken } = response.data\r\n                    setTrueSuccess(true)\r\n                }\r\n                catch (err) {\r\n                    console.error(err)\r\n                }\r\n            }\r\n\r\n            if (!token && persist) verifyRefreshToken()\r\n        }\r\n\r\n        return () => effectRan.current = true\r\n\r\n        // eslint-disable-next-line\r\n    }, [])\r\n\r\n\r\n    let content\r\n    if (!persist) { // persist: no\r\n        console.log('no persist')\r\n        content = <Outlet />\r\n    } else if (isLoading) { //persist: yes, token: no\r\n        console.log('loading')\r\n        content = <p>Загрузка...</p>\r\n    } else if (isError) { //persist: yes, token: no\r\n        console.log('error')\r\n        content = (\r\n            <p className='errmsg'>\r\n                {`${error?.data?.message} - `}\r\n                <Link to=\"/login\">Пожалуйста, войдите еще раз</Link>.\r\n            </p>\r\n        )\r\n    } else if (isSuccess && trueSuccess) { //persist: yes, token: yes\r\n        console.log('success')\r\n        content = <Outlet />\r\n    } else if (token && isUninitialized) { //persist: yes, token: yes\r\n        console.log('token and uninit')\r\n        console.log(isUninitialized)\r\n        content = <Outlet />\r\n    }\r\n\r\n    return content\r\n}\r\nexport default PersistLogin"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}